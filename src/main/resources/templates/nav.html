<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head-config">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="/main.css" rel="stylesheet">
</head>
<body>
    <div class="nav" th:fragment="navbar">
        <a class="logo" href="/">SpringMall</a>

        <span id="nav-guest">
            <a href="/login">Login</a>
            <a href="/register">Register</a>
        </span>

        <span id="nav-user" style="display:none">
            <a href="/list/page/1">List</a>
            <a href="javascript:void(0);" onclick="moveWithToken('/write')">Write</a>
            <a href="/my-page">
                <span id="nickname-box">User님</span>
            </a>
            <a href="/sales">OrderList</a>
            <button onclick="logout()">Logout</button>
        </span>

        <script>
            (function checkLoginStatus() {
                // 토큰 확인
                const token = localStorage.getItem('accessToken');

                // 토큰이 있다면 사용자 버전
                if(token) {
                    document.getElementById('nav-guest').style.display = 'none';
                    document.getElementById('nav-user').style.display = 'inline-block';

                    try {
                        const payload = parseJwt(token);
                        // MemberController 에서 .claim("displayName", 게터로 가져온 값) 에 해당됨
                        if(payload.displayName) {
                        document.getElementById('nickname-box').innerText = payload.displayName;
                        }
                     } catch(e){
                        console.error("토큰 읽기 실패:", e);
                     }
                }
                // 토큰 없으면 게스트 버전
            })();

            // JWT 한글 깨짐 방지 토큰 해독
            function parseJwt(token){
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c){
                    return '%' + ( '00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }

            // 로그아웃 메서드
            function logout(){
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                alert('로그아웃 되었습니다');
                window.location.href= '/login';
            }

            // 페이지 이동 시 토큰이 필요할 때 사용되는 메서드
            function moveWithToken(url){
                const token = localStorage.getItem('accessToken');
                if(token){
                    window.location.href = url;
                } else {
                    alert('로그인이 필요합니다');
                    window.location.href = '/login';
                }
            }
        </script>
    </div>
</body>
</html>
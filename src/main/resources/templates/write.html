<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>상품 등록</title>
    <th:block th:replace="~{ nav :: head-config }"></th:block>
</head>
<body>
<div th:replace="~{ nav :: navbar }"></div>

<div class="container" style="padding: 20px;">
    <h3>상품 등록</h3>

    <form onsubmit="return false;">
        <input id="title" name="title" placeholder="상품명">
        <input id="price" name="price" type="number" placeholder="가격">

        <input type="file" id="fileInput" onchange="uploadImage(this)">

        <input type="hidden" id="savedImageUrl">

        <button onclick="registerItem()">상품 등록</button>
    </form>

    <div style="margin-top: 10px;">
        <img id="preview" src="" style="max-width: 300px; display: none;">
    </div>
</div>

<script>

    // ---------------------------------------------------------
    // 1. 이미지 S3 업로드 (Presigned URL)
    // ---------------------------------------------------------
    async function uploadImage(input){
        if(!input.files || !input.files[0]) return;

        const file = input.files[0];
        const name = encodeURIComponent(file.name);

        const token = localStorage.getItem('accessToken');
        if(!token){
            alert('로그인이 필요합니다.');
            location.href= '/login';
            return;
        }

        try {
            // (1) 서버에 URL 요청
            let result = await fetch('/presigned-url?filename=' + name, {
                method: 'GET',
                headers : {
                    'Authorization': 'Bearer ' + token
                }
            });

            if(!result.ok) throw new Error("Presigned URL 발급 실패");

            let presignedUrl = await result.text();
            console.log("받은 URL:", presignedUrl);

            // (2) S3에 파일 업로드
            let uploadResult = await fetch(presignedUrl, {
                method: 'PUT',
                body: file
            });

            if(uploadResult.ok){
                const cleanUrl = presignedUrl.split("?")[0];
                console.log("최종 이미지 주소:", cleanUrl);

                document.querySelector('#preview').src = cleanUrl;
                document.querySelector('#preview').style.display = 'block';
                document.querySelector('#savedImageUrl').value = cleanUrl;
            } else {
                alert("이미지 업로드 실패");
            }
        } catch(error){
            console.error(error);
            alert("에러 발생:" + error.message);
        }
    }

    // ---------------------------------------------------------
    // 2. 상품 정보 등록
    // ---------------------------------------------------------
    function registerItem(){
        const title = document.getElementById('title').value;
        const price = document.getElementById('price').value;
        let imgUrl = document.getElementById('savedImageUrl').value;

        // 이미지 없으면 기본 이미지
        if(!imgUrl){
            imgUrl = "https://placehold.co/300";
        }

        if(!title || !price){
            alert("상품명과 가격을 입력해주세요.");
            return;
        }

        const token = localStorage.getItem('accessToken');

        fetch('/add', {
            method:'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                title: title,
                price: parseInt(price),
                imgUrl: imgUrl
            })
        })
        .then(response => {
            if(response.ok){
                alert("상품이 등록되었습니다");
                // 리스트 페이지로 이동
                location.href= '/list/page/1';
            } else {
                return response.text().then(text => { throw new Error(text) });
            }
        })
        .catch(error => {
            console.error(error);
            alert("등록 실패:" + error.message);
        });
    }
</script>

</body>
</html>
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <th:block th:replace="~{ nav :: head-config }"></th:block>

    <style>
        /* ê°„ë‹¨í•œ ë§ˆì´í˜ì´ì§€ ìŠ¤íƒ€ì¼ë§ */
        .mypage-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .profile-img {
            width: 100px;
            height: 100px;
            background-color: #eee;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        .user-info h2 { margin: 10px 0; color: #333; }
        .user-info p { color: #666; margin: 5px 0; }
        .badge {
            display: inline-block;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        .guest-message { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div th:replace="~{ nav :: navbar }"></div>

<div class="mypage-container">

    <div id="profile-card" style="display: none;">
        <div class="profile-img">ğŸ‘¤</div>

        <div class="user-info">
            <h2><span id="displayName">ì‚¬ìš©ì</span>ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</h2>

            <span id="role-badge" class="badge">ê¶Œí•œ ì—†ìŒ</span>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div style="text-align: left; padding: 0 20px;">
            <h4>ë‚´ í™œë™</h4>
            <ul>
                <li>ìµœê·¼ ë¡œê·¸ì¸: <span id="login-time">ë°©ê¸ˆ ì „</span></li>
                <li>ë¡œê·¸ì¸ ìƒíƒœ: <span style="color: green; font-weight: bold;">ì¸ì¦ë¨ (Authenticated)</span></li>
            </ul>
        </div>
    </div>

    <div id="guest-card">
        <h4 class="guest-message">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</h4>
        <p>ë¡œê·¸ì¸ í›„ ë‚´ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        <a href="/login" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 5px;">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
    </div>

</div>

<script>
    (function initMyPage() {
        const token = localStorage.getItem('accessToken');

        if (token) {
            // í† í°ì´ ìˆìœ¼ë©´ í”„ë¡œí•„ ë³´ì—¬ì£¼ê³ , ê²ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ¨ê¹€
            document.getElementById('profile-card').style.display = 'block';
            document.getElementById('guest-card').style.display = 'none';

            try {
                // í† í° í•´ë…
                const payload = parseJwt(token);
                console.log("Token Payload:", payload);

                // ì •ë³´ ì±„ì›Œë„£ê¸°
                //  ì•„ì´ë”” (subject)
                if (payload.sub) {
                    document.getElementById('username').innerText = payload.sub;
                }
                //  ë‹‰ë„¤ì„ (displayName)
                if (payload.displayName) {
                    document.getElementById('displayName').innerText = payload.displayName;
                }
                //  ê¶Œí•œ (role)
                if (payload.role) {
                    const badge = document.getElementById('role-badge');
                    badge.innerText = payload.role;

                    // ê´€ë¦¬ìë©´ ìƒ‰ê¹” ë°”ê¾¸ê¸° (ì˜ˆì‹œ)
                    if(payload.role === 'ROLE_ADMIN') {
                        badge.style.backgroundColor = '#dc3545'; // ë¹¨ê°„ìƒ‰
                    }
                }

            } catch (e) {
                console.error("í† í° íŒŒì‹± ì—ëŸ¬", e);
                alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                location.href = '/login';
            }
        } else {
            // í† í° ì—†ìœ¼ë©´ ê²ŒìŠ¤íŠ¸ ì¹´ë“œ ìœ ì§€
        }
    })();

// í† í° í•´ë… í•¨ìˆ˜ (ì¬ì‚¬ìš©)
    function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');

        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }
</script>

</body>
</html>